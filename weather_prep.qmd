---
title: "Weather Extremes in Singapore 2023"
author: "Team Violetred"
date: "2024-05-24"
format: html
---

## Introduction
This report analyzes the weather extremes in Singapore for the year 2023, highlighting significant weather conditions across different regions. 

## Required Libraries
The following code block loads several R packages that are necessary for data manipulation, visualization, and geographical data handling. Each package serves a specific purpose:

- `tidyverse`: A collection of packages for data manipulation and visualization.
- `readxl`: For reading Excel files.
- `ggplot2` and `ggrepel`: For creating advanced plots.
- `ggimage`: To add images to ggplot.
- `sf`: For handling spatial data.
- `tibble` and `dplyr`: For data manipulation.
- `geojsonsf`: For converting GeoJSON to simple features.
- `scales` and `viridis`: For custom scales and color palettes.
- `ggspatial`: For adding spatial elements like north arrows to plots.
- `leaflet`: For creating interactive maps.
- `stringr`: For string manipulation.
- `rvest`: For web scraping.

```{r}
#| label: setup
#| include: false

# Load necessary libraries
library(tidyverse)
library(readxl)
library(ggplot2)
library(ggrepel)
library(ggimage) # To add the icons above the labels
library(sf)
library(tibble)
library(dplyr)
library(geojsonsf)
library(scales)
library(viridis) # For color-blind friendly palette
library(ggspatial) # For north arrow and scale bar
library(leaflet) # For interactive maps
library(stringr) # For string manipulation
library(rvest) # For web scraping
```

## Loading the datasets
This code block loads the weather data and Singapore city coordinates into R. The weather data is read from an Excel file and the coordinates from a CSV file. This data will be used for subsequent analysis.
```{r}
weather_data <- read_excel("full_year_weather_data.xlsx")
sg_coords <- read_csv("singapore_city_coordinates_improved.csv")
```

## Cleaning the datasets
This section performs several cleaning steps on the weather data:

- Date Conversion: Adds the year 2023 to the date entries and converts them to a `Date` format.
- Rainfall Conversion: Converts the 'Daily Rainfall Total' column to numeric, forcing any non-numeric values to `NA`.
- Removing Missing Values: Filters out rows with `NA` values in the 'Daily Rainfall Total' column to ensure clean data for analysis.
```{r}
# Add the year to the date entries and convert to datetime format
weather_data <- weather_data %>%
  mutate(Date = as.Date(paste(Date, "2023"), format = "%d %b %Y"))

# Convert Daily Rainfall Total to numeric, forcing non-numeric values to NA
weather_data <- weather_data %>%
  mutate(`Daily Rainfall Total (mm)` = as.numeric(`Daily Rainfall Total (mm)`))

# Remove rows with NA values in the Daily Rainfall Total column
weather_data <- weather_data %>%
  filter(!is.na(`Daily Rainfall Total (mm)`))
```

## Combining the datasets
This section merges the cleaned weather data with city coordinates. It performs the following steps:

- Selecting Relevant Columns: Extracts the relevant columns from the city coordinates dataset.
- Joining Data: Joins the weather data with city coordinates based on city and place names.
- Combining Results: Combines the joined datasets, ensuring all records with valid coordinates are included.
```{r}
sg_coords <- sg_coords |>
  select(place = `Place`, city = `City`, y = `latitude`, x = `longitude`)

# Join on the "city" column
join_city <- weather_data %>%
  left_join(sg_coords, by = c("Location" = "city"))

# Join on the "place" column
join_place <- weather_data %>%
  left_join(sg_coords, by = c("Location" = "place"))


# Combine the results
combined_weather_data <- bind_rows(
  join_city %>% filter(!is.na(x) & !is.na(y)),
  join_place %>% filter(!is.na(x) & !is.na(y))
)

combined_weather_data
```

## Displaying the cleaned data
This block displays the first few rows of the cleaned and combined weather data, allowing for a quick inspection to ensure the data is correctly processed.
```{r}
# View the cleaned data
head(combined_weather_data)
```

## Total Rainfall Analysis
In this section, we analyze total rainfall by:

- Selecting Columns: Selecting relevant columns for analysis.
- Formatting Dates: Formatting the date column to a monthly format.
- Summarizing Data: Summarizing total rainfall by location and date.
- Identifying Extremes: Finding the top 10 wettest and driest periods.
```{r}
weather_total_rainfall <- combined_weather_data |>
  select(
    location = `Location`, date = `Date`, `Daily Rainfall Total (mm)`, x, y
  ) |>
  mutate(date = format(date, "%Y-%m")) |>
  summarise(
    total_rainfall =
      sum(`Daily Rainfall Total (mm)`, na.rm = TRUE),
    .by = c(location, date, x, y)
  )

wettest <- weather_total_rainfall |>
  slice_max(total_rainfall, n = 10, with_ties = FALSE)

driest <- weather_total_rainfall |>
  slice_min(total_rainfall, n = 10, with_ties = FALSE)

wettest
driest
```

## Temperature Analysis
This section analyzes the mean temperature by:

- Selecting Columns: Selecting relevant columns for analysis.
- Formatting and Converting Data: Formatting the date column and converting temperature values to numeric.
- Summarizing Data: Summarizing mean temperature by location and date.
- Identifying Extremes: Finding the top 10 hottest and coolest periods.
```{r}
weather_temperature <- combined_weather_data |>
  select(
    location = `Location`, date = `Date`, temp = `Mean Temperature (°C)`, x, y
  ) |>
  mutate(date = format(date, "%Y-%m"), temp = as.numeric(temp)) |>
  summarise(
    mean_temperature = mean(temp, na.rm = TRUE), .by = c(location, date, x, y)
  )

hottest <- weather_temperature |>
  slice_max(mean_temperature, n = 10, with_ties = FALSE)

coolest <- weather_temperature |>
  slice_min(mean_temperature, n = 10, with_ties = FALSE)

hottest
coolest
```

## Wind Gust Analysis
This section analyzes the maximum wind speed by:

- Selecting Columns: Selecting relevant columns for analysis.
- Formatting and Converting Data: Formatting the date column and converting wind speed values to numeric.
- Identifying Extremes: Finding the top 10 highest wind speeds.
```{r}
weather_wind_speed <- combined_weather_data |>
  select(
    location = `Location`, date = `Date`, wind_speed = `Max Wind Speed (km/h)`,
    x, y
  ) |>
  mutate(date = format(date, "%Y-%m"), wind_speed = as.numeric(wind_speed))

weather_wind_speed <- weather_wind_speed |>
  slice_max(wind_speed, n = 10, with_ties = FALSE)

weather_wind_speed
```

## Combining Extreme Weather Events
In this section, we combine the extreme weather events (rainfall, temperature, and wind speed) into a single dataset. This dataset will be used to summarize and visualize the most extreme weather events.
```{r}
combined_extremes <- bind_rows(
  wettest %>% mutate(event = "Wettest", amount = total_rainfall),
  driest %>% mutate(event = "Driest", amount = total_rainfall),
  hottest %>% mutate(event = "Temperature (Hot)", amount = mean_temperature),
  coolest %>% mutate(event = "Temperature (Cool)", amount = mean_temperature),
  weather_wind_speed %>% mutate(event = "Wind Speed", amount = wind_speed)
)

combined_extremes
```

## Preparing for Map Plot
This section prepares the data for mapping by:

- Defining Color Palette: Creating a custom color palette for different weather events.
- Identifying Most Extreme Events: Selecting the most extreme weather events for each category.
- Preparing Labels: Preparing labels with additional details (e.g., icons, units) for use in the map plot.
```{r}
# Custom color palette
event_colors <- c(
  "Wettest" = "#7a47cc",
  "Driest" = "#e3d345",
  "Temperature (Cool)" = "#65d8e7",
  "Temperature (Hot)" = "#d73027",
  "Wind Speed" = "#71cfab"
)

wettest_date <-
  combined_extremes |>
  slice_max(total_rainfall, n = 1, with_ties = FALSE) |>
  mutate(event = "Wettest", amount = total_rainfall)

driest_date <-
  combined_extremes |>
  slice_min(total_rainfall, n = 1, with_ties = FALSE) |>
  mutate(event = "Driest", amount = total_rainfall)

hottest_date <-
  combined_extremes |>
  slice_max(mean_temperature, n = 1, with_ties = FALSE) |>
  mutate(event = "Hottest Mean Temp", amount = mean_temperature)

coolest_date <-
  combined_extremes |>
  slice_min(mean_temperature, n = 1, with_ties = FALSE) |>
  mutate(event = "Coldest Mean Temp", amount = mean_temperature)

strongest_wind_gust <-
  combined_extremes |>
  slice_max(wind_speed, n = 1, with_ties = FALSE) |>
  mutate(event = "Highest Wind Speed", amount = wind_speed)

labels <- bind_rows(
  wettest_date,
  driest_date,
  hottest_date,
  coolest_date,
  strongest_wind_gust
) |>
  mutate(
    unit = c("mm", "mm", "°C", "°C", "km/h"),
    icon = c(
      "icons/rainfall_icon.png",
      "icons/dry_icon.png",
      "icons/sun_icon.png",
      "icons/cool_temperature_icon.png",
      "icons/wind_icon.png"
    ), # Order: Wettest, Driest, Hottest, Coolest, Windiest
    nudge_x_icon = c(0.096, 0.065, 0.129, 0.047, -0.074),
    nudge_y_icon = c(0.102, -0.127, -0.084, 0.125, 0.090),
    nudge_x_repel = c(0.07, 0.053, 0.081, 0.008, -0.155),
    nudge_y_repel = c(0.078, -0.096, -0.069, 0.13, 0.07)
  )

labels
```
